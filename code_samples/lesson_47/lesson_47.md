# Lesson 47
29.02.2024

Подготовка и оптимизация БД для проекта "Карточки запоминания" (Anki).

Для достижения вашей конечной цели с использованием SQLite 3, Python и модуля для чтения CSV, вы можете следовать следующему плану действий. Этот план предполагает, что у вас уже есть базовые знания о том, как работать с SQLite и Python.

1. **Подготовка данных**:
   - Убедитесь, что ваш CSV файл корректно структурирован и содержит необходимые столбцы: ID, Категории, Теги (где теги представлены в формате JSON-строки).

2. **Создание структуры базы данных**:
   - Создайте новую базу данных SQLite или используйте существующую.
   - Определите структуру таблицы для карточек (если она уже не создана).
   - Создайте таблицу для тегов, которая будет содержать уникальные идентификаторы тегов и сами теги.
   - Создайте связующую таблицу многие ко многим, чтобы связать карточки с тегами. Эта таблица должна содержать внешние ключи, указывающие на таблицу карточек и таблицу тегов.

3. **Чтение и обработка CSV файла**:
   - Используйте Python и модуль `csv` для чтения вашего CSV файла.
   - Для каждой записи извлеките ID, категории, и разберите JSON-строку тегов на отдельные теги.
   - Нобходимо сформировать сет с уникальными тегами, чтобы избежать дублирования в таблице тегов.
   - После чего можно будет начать заполнение таблиц.

На данном этапе вам необходимо написать функцию чтения данных из CSV файла и функцию для разбора JSON-строки тегов и категорий на сеты.

Функция 1. get_data_from_csv(file_path: str) -> List[Dict[str, Union[int, str]]]:
Функция 2. parse_unique_data_by_key(data: List[Dict[str, Union[int, str]]], key: str) -> Set[str]:


4. **Заполнение таблицы тегов**:
   - Для каждого уникального тега, найденного в CSV файле, производим вставку в таблицу тегов. Используйте `INSERT INTO` для добавления новых тегов в таблицу.

5. **Заполнение таблицы категорий**:
   - Для каждой уникальной категории, найденной в CSV файле, производим вставку в таблицу категорий. Используйте `INSERT INTO` для добавления новых категорий в таблицу.

6. **Заполнение связующей таблицы**:
   - В нашем распоряжении есть id + категории + теги.
   - Мы можем прочитать данные из новой БД (Tags) и получить id + теги.
   - Мы можем взять вариант Руслана или Дмитрия (где из CSV мы получаем список словарей, по ключу tags - список или сет Пайтон)
   - Мы обходим список словарей. Для каждого словаря, мы получаем id, и список тегов.
   - Мы обходим список тегов во внутреннем цикле и для каждого тега взять его id из таблицы Tags и добавить в связующую таблицу.

Можно делать запись на каждой итерации. Можно сформировать уникальную коллекцию, например сет кортежей и вставить все сразу.

7. **Заполнение главной таблицы**:
На данном этапе, у нас есть заполненные таблицы `Tags` и `Categories` в новой БД.
Мы можем начать заполнение главной таблицы `Cards`.

   - Нобходимо прочитать данные из старой БД, id, вопросы, ответы.
   - Ореинтируемся на связку ID из CSV. Ищем в CSV по ID, категории - подставляем id категории из таблицы Categories.
Все данные в таблице `Cards` проставятся автоматически. Ваша задача перенести ВСЕ данные из старой БД в новую.
Обязательные поля - question, answer, category_id (взять из таблицы Categories)

Обратите внимание, что в CSV файл данные попали через `SELECT DISTINCT question, answer, CardID FROM Cards;` это означает, что
читая данные из старой БД, вам желательно выполнить такой же запрос, чтобы не было проблем.

Технически их недолжно быть, т.к. мы опираемся на ID из старой базы, но лучше убедиться.

8. **Проверка данных**:
   - Теперь вы можете использовать SQL запросы для извлечения карточек на основе различных критериев, таких как категории, теги или комбинации тегов.

В зависимости от ваших потребностей, этот план может быть адаптирован или расширен. Например, если вам нужно также обновлять или удалять карточки и теги, вам потребуется реализовать соответствующую логику.